---
import { Image } from "astro:assets";
import Layout from "~/layouts/Layout.astro";
import { contentfulClient, isAssetLink } from "~/lib/contentful";
import type { TypePostSkeleton } from "~/types/content";

const entries = await contentfulClient.getEntries<TypePostSkeleton>({
	content_type: "post",
	order: ["fields.priority", "fields.date"],
	include: 2,
});

const posts = entries.items.map((item) => {
	const {
		title,
		date,
		description,
		slug,
		thumbnail,
		gallery,
		priority,
		content,
	} = item.fields;
	return {
		thumbnail: isAssetLink(thumbnail) ? thumbnail : null,
		gallery: gallery?.map((item) => (isAssetLink(item) ? item : null)),
		priority,
		content,
		title,
		slug,
		description,
		date: new Date(date).toLocaleDateString(),
	};
});
---

<Layout title="Cikkek">
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        {
            posts.map((post) => (
                <div class="bg-bg-highlight shadow-md rounded-lg overflow-hidden">
                    {post.thumbnail?.fields?.file?.url && (
                        <Image
                            src={post.thumbnail.fields.file.url}
                            alt={post.thumbnail.fields.title ?? ""}
                            width={192}
                            height={192}
                            class="object-cover"
                        />
                    )}
                    <div class="p-6">
                        <h2 class="text-xl font-semibold mb-2">{post.title}</h2>
                        <p class="text-gray-600 mb-4">{post.description}</p>
                        <div class="flex justify-between items-center mb-4">
                            <span class="text-sm text-gray-500">
                                {post.date}
                            </span>
                            {post.priority && (
                                <span class="text-sm text-gray-500">
                                    Priority: {post.priority}
                                </span>
                            )}
                        </div>
                        {post.gallery && post.gallery.length > 0 && (
                            <div class="mb-4">
                                <h3 class="text-lg font-semibold mb-2">
                                    Gallery
                                </h3>
                                {post.gallery.length > 0 && (
                                    <div class="flex space-x-2 overflow-x-auto">
                                        {post.gallery.map(
                                            (image) =>
                                                image?.fields?.file?.url && (
                                                    <Image
                                                        src={
                                                            image.fields.file
                                                                .url
                                                        }
                                                        alt={
                                                            image.fields
                                                                .title ?? ""
                                                        }
                                                        width={192}
                                                        height={192}
                                                        class="object-cover rounded"
                                                    />
                                                ),
                                        )}
                                    </div>
                                )}
                            </div>
                        )}
                        <div class="mt-4">
                            <a
                                href={`/cikkek/${post.slug}`}
                                class="text-blue-500 hover:text-blue-700"
                            >
                                Read more
                            </a>
                        </div>
                    </div>
                </div>
            ))
        }
    </div>
</Layout>
